<html>
<head>
  <title>Beats per minute calculator</title>
  <script type="text/javascript">

  var timestampCount = 9;
  var timestamps   = [];
  var timeout;

  // TODO: The main issue with this code is that the calculations
  // become unreliable when bpm is greater than 200. Either the 
  // event loop can't keep up, the granularity of Date is not fine
  // enough, or something else is amiss.
  function recordMouseDown(e)
  {
    clearTimeout(timeout);
    timeout = setTimeout("reset()", 5000);

    var date = new Date();
    
    timestamps.push(date.getTime());
    if (timestamps.length > timestampCount) {
      timestamps.shift();
    }

    var lastIndex = timestamps.length - 1;
    var x   = 60 * lastIndex;
    var bpm = x / ((timestamps[lastIndex] - timestamps[0]) / 1000);

    if (timestamps.length === 1) {
      document.getElementById('bpm').innerHTML = 'First beat ...';  
    }
    else {
      document.getElementById('bpm').innerHTML = TwoDP(bpm);
    }     
    randomColor();
  }

  function showDebugTimeStamps()
  {
    var s = '';
    var i;
    for (i=0; i < timestamps.length; i++)
    {
      s = s + 't[' + i + '] = ' + timestamps[i] + '<br>';
    }

    document.getElementById('debug').innerHTML = s;
  }

  function TwoDP(X) 
  {
      var D, C, T;
      with (Math) {
          D = floor(X);
          C = round(100 * (X - D));
          T = C % 10;
      }    
      return D + "." + (C - T) / 10 + T;
  }

  function reset()
  {
    timestamps = [];
  }

  function randomColor()
  {
    // TODO: Clean up this code if you feel so inclined.
    var r = Math.floor(Math.random() * 256);
    var g = Math.floor(Math.random() * 256);
    var b = Math.floor(Math.random() * 256);

    var rString = r.toString(16);
    var gString = g.toString(16);
    var bString = b.toString(16);

    if (r <= 16 && rString != '10') {
      rString = '0' + rString;
    }
    if (g <= 16 && gString != '10') {
      gString = '0' + gString;
    }
    if (b <= 16 && bString != '10') {
      bString = '0' + bString;
    }

    var color = '#' + rString + gString + bString;
    document.getElementById('square').style.backgroundColor = color;
  }
  </script>

  <style><!--
    BODY { 

    }

    #container {
      background-color: white;
      margin-left: 3em;
      margin-top: 1ex;
      width: 550px;
    }
    P {
      font-family: Verdana;
      font-size: 10pt;
    }

    H3 {
      font-family: Georgia;
    }

    #square {
      border: 1px solid black;
      padding: 3em;
      text-align: center;
    }
--></style>
</head>
<body>
  <div id="container">
   <h3>Beats per minute calculator</h3>

   <P>Click the box to the beat of your music; click it about 9 times for
   an accurate result.</P>

   <P>It will reset after 5 seconds of idle time.</P>

   <p id="square" onmousedown="recordMouseDown()"></p>
   <p>Beats per minute: <span id="bpm">0</span></p>

<!-- <INPUT onclick="showDebugTimeStamps()" type="button">
   <p id="debug"></p> -->
  </div>
</body>
</html>